from aiogram import Router, types, F
from aiogram.types import Message
from bot.services.business_connection_service import BusinessConnectionService
from bot.services.user_whitelist_service import UserWhitelistService
import logging

logger = logging.getLogger(__name__)
whitelist_service = UserWhitelistService()

router = Router()

@router.message(F.text.startswith("/start"))
async def handle_start(message: Message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start"""
    await message.answer(
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ–∫-–ª–∏—Å—Ç–∞–º–∏!\n\n"
        "üéØ –≠—Ç–æ—Ç –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Telegram Business –∏ —Å–æ–∑–¥–∞–µ—Ç —á–µ–∫-–ª–∏—Å—Ç—ã –ø—Ä—è–º–æ –≤ –≤–∞—à–∏—Ö –±–∏–∑–Ω–µ—Å-—á–∞—Ç–∞—Ö.\n\n"
        "üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:\n"
        "1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–æ—Ç–∞ –∫ –≤–∞—à–µ–º—É –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç—É (/business)\n"
        "2. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö (/adduser @username)\n"
        "3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –∏–∑ –±–∏–∑–Ω–µ—Å-—á–∞—Ç–∞\n"
        "4. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç —á–µ–∫-–ª–∏—Å—Ç\n\n"
        "üí° –§–æ—Ä–º–∞—Ç—ã —Å–ø–∏—Å–∫–æ–≤:\n"
        "‚Ä¢ –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ (1. –ó–∞–¥–∞—á–∞, 2. –ó–∞–¥–∞—á–∞)\n"
        "‚Ä¢ –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏\n"
        "‚Ä¢ –ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º."
    )

@router.message(F.text.startswith("/help"))
async def handle_help(message: Message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /help"""
    await message.answer(
        "‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ–∫-–ª–∏—Å—Ç–∞–º–∏\n\n"
        "üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "/business - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–∏–∑–Ω–µ—Å-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\n\n"
        "üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞):\n"
        "/adduser @username –∏–ª–∏ ID - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
        "/removeuser @username –∏–ª–∏ ID - –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
        "/users - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n\n"
        "üìù –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —á–µ–∫-–ª–∏—Å—Ç:\n"
        "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç—É\n"
        "2. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö\n"
        "3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á (–º–∏–Ω–∏–º—É–º 2) –∏–∑ –±–∏–∑–Ω–µ—Å-—á–∞—Ç–∞:\n"
        "   ‚Ä¢ 1. –ö—É–ø–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã\n"
        "   ‚Ä¢ 2. –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É\n"
        "   ‚Ä¢ 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç\n"
        "4. –ë–æ—Ç —Å–æ–∑–¥–∞—Å—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç\n\n"
        "‚ö†Ô∏è –í–∞–∂–Ω–æ: –ë–æ—Ç —Å–æ–∑–¥–∞—ë—Ç —á–µ–∫-–ª–∏—Å—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Å–ø–∏—Å–∫–∞!"
    )

@router.message(F.text.startswith("/business"))
async def handle_business_status(message: Message):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–∏–∑–Ω–µ—Å-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"""
    try:
        business_service = BusinessConnectionService()
        connection_id = business_service.get_active_connection()

        if connection_id:
            await message.answer(
                "‚úÖ –°—Ç–∞—Ç—É—Å –±–∏–∑–Ω–µ—Å-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:\n"
                f"ID: `{connection_id}`\n"
                f"–°—Ç–∞—Ç—É—Å: üü¢ –ê–∫—Ç–∏–≤–Ω–æ\n\n"
                f"–ß–µ–∫-–ª–∏—Å—Ç—ã –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ! –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–ø–∏—Å–∫–∏ –∏–∑ –±–∏–∑–Ω–µ—Å-—á–∞—Ç–æ–≤."
            )
        else:
            await message.answer(
                "‚ùå –°—Ç–∞—Ç—É—Å –±–∏–∑–Ω–µ—Å-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:\n"
                f"ID: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ\n"
                f"–°—Ç–∞—Ç—É—Å: üî¥ –ù–µ–∞–∫—Ç–∏–≤–Ω–æ\n\n"
                f"üì± –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é:\n"
                f"1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å Telegram Business –∞–∫–∫–∞—É–Ω—Ç\n"
                f"2. –ù–∞–π–¥–∏—Ç–µ —ç—Ç–æ–≥–æ –±–æ—Ç–∞ –≤ –ø–æ–∏—Å–∫–µ\n"
                f"3. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–æ—Ç–∞ –∫ –≤–∞—à–µ–º—É –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö\n"
                f"4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –∏–∑ –±–∏–∑–Ω–µ—Å-—á–∞—Ç–∞\n\n"
                f"–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ–∫-–ª–∏—Å—Ç—ã –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!"
            )

        logger.info(f"–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –±–∏–∑–Ω–µ—Å-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –¢–µ–∫—É—â–∏–π ID: {connection_id}")

    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞: {str(e)}")
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∏–∑–Ω–µ—Å-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {e}")
        import traceback
        traceback.print_exc()

@router.message(F.text.startswith("/adduser"))
async def handle_add_user(message: Message):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ whitelist"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    if not whitelist_service.is_owner(message.from_user.id):
        await message.answer("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞.")
        return

    # –ü–∞—Ä—Å–∏–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–∑ –∫–æ–º–∞–Ω–¥—ã
    parts = message.text.split(maxsplit=1)
    if len(parts) < 2:
        await message.answer(
            "‚ùå –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
            "–§–æ—Ä–º–∞—Ç: /adduser @username –∏–ª–∏ /adduser 123456789"
        )
        return

    identifier = parts[1].strip()
    if not identifier:
        await message.answer("‚ùå –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.")
        return

    success, msg = whitelist_service.add_user(identifier, message.from_user.id)
    if success:
        await message.answer(f"‚úÖ {msg}")
        logger.info(f"{msg} –≤–ª–∞–¥–µ–ª—å—Ü–µ–º {message.from_user.id}")
    else:
        await message.answer(f"‚ÑπÔ∏è {msg}")

@router.message(F.text.startswith("/removeuser"))
async def handle_remove_user(message: Message):
    """–£–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ whitelist"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    if not whitelist_service.is_owner(message.from_user.id):
        await message.answer("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞.")
        return

    # –ü–∞—Ä—Å–∏–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–∑ –∫–æ–º–∞–Ω–¥—ã
    parts = message.text.split(maxsplit=1)
    if len(parts) < 2:
        await message.answer(
            "‚ùå –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
            "–§–æ—Ä–º–∞—Ç: /removeuser @username –∏–ª–∏ /removeuser 123456789"
        )
        return

    identifier = parts[1].strip()
    if not identifier:
        await message.answer("‚ùå –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.")
        return

    success, msg = whitelist_service.remove_user(identifier)
    if success:
        await message.answer(f"‚úÖ {msg}")
        logger.info(f"{msg} –≤–ª–∞–¥–µ–ª—å—Ü–µ–º {message.from_user.id}")
    else:
        await message.answer(f"‚ùå {msg}")

@router.message(F.text.startswith("/users"))
async def handle_list_users(message: Message):
    """–í—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    if not whitelist_service.is_owner(message.from_user.id):
        await message.answer("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞.")
        return

    users = whitelist_service.get_all_users()

    if not users:
        await message.answer(
            "üìã –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—É—Å—Ç.\n\n"
            "–î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–æ–º–∞–Ω–¥–æ–π:\n"
            "/adduser @username –∏–ª–∏ /adduser 123456789"
        )
        return

    user_list = "\n".join([f"‚Ä¢ {u}" for u in users])
    await message.answer(
        f"üìã –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ({len(users)}):\n\n"
        f"{user_list}\n\n"
        f"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:\n"
        f"/adduser @username –∏–ª–∏ ID - –¥–æ–±–∞–≤–∏—Ç—å\n"
        f"/removeuser @username –∏–ª–∏ ID - —É–¥–∞–ª–∏—Ç—å"
    )

@router.message(F.text)
async def handle_text_message(message: Message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞"""
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞: {message.text[:50]}...")
    
    await message.answer(
        "‚ÑπÔ∏è –≠—Ç–æ—Ç –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Telegram Business.\n\n"
        "‚ùå –ß–µ–∫-–ª–∏—Å—Ç—ã –Ω–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–∑ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç—É.\n\n"
        "‚úÖ –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —á–µ–∫-–ª–∏—Å—Ç:\n"
        "1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–æ—Ç–∞ –∫ –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç—É (/business)\n"
        "2. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫ (/adduser @username)\n"
        "3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –∏–∑ –±–∏–∑–Ω–µ—Å-—á–∞—Ç–∞\n\n"
        "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ\n"
        "/help - –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞\n"
        "/business - –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
        "/users - –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    )