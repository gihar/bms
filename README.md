# Telegram Checklist Bot

Бот для создания интерактивных чек-листов из текстовых сообщений с поддержкой бизнес-аккаунтов Telegram.

## Возможности

- Автоматическое создание чек-листов из текстовых сообщений
- Использование нативных чек-листов Telegram (Bot API 7.0+)
- Поддержка различных форматов ввода:
  - Через запятую: `Молоко, Хлеб, Сыр`
  - Нумерованные списки: `1. Купить молоко\n2. Купить хлеб`
  - Маркированные списки: `• Молоко\n• Хлеб\n• Сыр`
  - Markdown чекбоксы: `- [ ] задача`
  - Построчно: `Молоко\nХлеб\nСыр`
  - Через точку с запятой: `Молоко; Хлеб; Сыр`
  - Через вертикальную черту: `Купить молоко | Купить хлеб`
  - Через "и": `Купить молоко и хлеб`
  - Через плюс: `Купить молоко + хлеб`
- Интерактивные чек-листы с возможностью отметки выполненных пунктов
- Хранение чек-листов в базе данных
- Поддержка бизнес-аккаунтов Telegram
- Управление whitelist пользователей для бизнес-аккаунтов
- Автоматическое определение формата ввода
- Ограничение длины задачи до 100 символов (требование Telegram API)

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository_url>
cd checklist_bot
```

2. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # для Windows: venv\Scripts\activate
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

5. Получите токен бота у [@BotFather](https://t.me/botfather) и добавьте его в `.env`:
```
BOT_TOKEN=your_telegram_bot_token_here
```

## Запуск

```bash
python bot/main.py
```

## Использование

### Для владельца бизнес-аккаунта

1. Подключите бота к вашему бизнес-аккаунту в настройках Telegram
2. Используйте команды в личном чате с ботом:
   - `/business` - проверить статус подключения
   - `/adduser @username` или `/adduser ID` - добавить пользователя в whitelist
   - `/removeuser @username` или `/removeuser ID` - удалить пользователя
   - `/users` - показать список разрешённых пользователей
   - `/help` - показать справку

### Для создания чек-листов

1. Убедитесь, что вы добавлены в whitelist владельцем бота
2. Отправьте список задач из бизнес-чата (минимум 2 задачи)
3. Бот автоматически создаст нативный чек-лист Telegram
4. Отмечайте выполненные пункты прямо в чек-листе

## Примеры сообщений

```
Купить молоко, хлеб, сыр, яйца
```

```
1. Убрать комнату
2. Помыть посуду
3. Вынести мусор
```

```
• Подготовить презентацию
• Отправить отчет
• Позвонить клиенту
```

## Архитектура

- `bot/main.py` - основной файл запуска бота с middleware для отладки
- `bot/handlers/` - обработчики сообщений и колбэков
  - `message_handler.py` - обработка текстовых сообщений
  - `callback_handler.py` - обработка нажатий на кнопки чек-листа
- `bot/services/` - бизнес-логика
  - `parser.py` - умный парсер текста с поддержкой множества форматов
  - `checklist_manager.py` - управление созданием и обновлением чек-листов
  - `business_connection_service.py` - работа с бизнес-аккаунтами
  - `user_whitelist_service.py` - управление whitelist пользователей
- `bot/models/` - модели базы данных (SQLAlchemy 2.0)
- `bot/utils/` - утилиты и конфигурация

## Технологический стек

- **Python 3.9+**
- **aiogram 3.22.0+** - фреймворк для создания Telegram ботов с поддержкой Bot API 7.0+
- **SQLAlchemy 2.0+** - ORM для работы с базой данных
- **SQLite** - база данных по умолчанию
- **python-dotenv** - управление переменными окружения

## Особенности реализации

- **Нативные чек-листы Telegram**: Использует `send_checklist()` API для создания нативных чек-листов
- **Автоматическое определение формата**: Парсер автоматически определяет формат ввода и преобразует его в чек-лист
- **Поддержка сложных выражений**: Учитывает запятые внутри скобок при парсинге
- **Отметка задач**: Выполняется нативно Telegram клиентом
- **Сохранение состояния**: Чек-листы сохраняются в БД для отслеживания
- **Бизнес-интеграция**: Работает с бизнес-аккаунтами Telegram для корпоративного использования
- **Whitelist система**: Только разрешённые пользователи могут создавать чек-листы
- **Автоматическое ограничение**: Длина каждой задачи ограничена 100 символами

## База данных

Бот использует следующие таблицы:

- `checklists` - хранит созданные чек-листы
- `tasks` - задачи внутри чек-листов с порядком и статусом выполнения
- `business_connections` - информация о подключениях к бизнес-аккаунтам
- `allowed_users` - whitelist пользователей для бизнес-аккаунта

## Особенности реализации

- **Автоматическое определение формата**: Парсер автоматически определяет формат ввода и преобразует его в чек-лист
- **Поддержка сложных выражений**: Учитывает запятые внутри скобок при парсинге
- **Интерактивные кнопки**: Каждая задача отображается как кнопка с возможностью отметки
- **Сохранение состояния**: Чек-листы сохраняются в БД и могут быть изменены позже
- **Бизнес-интеграция**: Может работать с бизнес-аккаунтами Telegram для корпоративного использования